<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyświetl test</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div id="header-placeholder"></div>
<div class="container mt-5">
    <h2>Test: [[${test.name}]]</h2>
    <div style="visibility: hidden" id="test-data">[[${test.id}]]</div>
    <div id="results-container" class="mt-3"></div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(function() {
        $("#header-placeholder").load("/header");
    });
    $(document).ready(function() {
        const testId = $('#test-data').text();

        $.ajax({
            url: `/admin/tests/result/${testId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const results = response.data.results;
                    let tableHtml = '<table class="table table-striped">';
                    tableHtml += '<thead><tr><th>Indeks</th><th>Wyniki</th><th>Ocena</th></tr></thead>';
                    tableHtml += '<tbody>';

                    for (const [username, attempts] of Object.entries(results)) {
                        console.log(attempts);
                        tableHtml += `<tr><td>${username}</td><td>`;
                        attempts.forEach(attempt => {
                            tableHtml += `Punkty: ${attempt.score}, Max punkty: ${attempt.maxScore}, Date: ${new Date(attempt.startDate).toLocaleString()}<br>`;
                        });
                        if(attempts.length > 1){
                            tableHtml+=`-------------------------------------------------------<br>`;
                            tableHtml+=`Średnia: <br>`;
                        }
                        tableHtml += `</td><td>`;
                        attempts.forEach(attempt => {
                            tableHtml += `${attempt.grade}<br>`;
                        });
                        if(attempts.length > 1){
                            tableHtml+=`---<br>`;
                            const grades = attempts.map(attempt => parseFloat(attempt.grade));
                            const totalGrade = grades.reduce((acc, grade) => acc + grade, 0);
                            const averageGrade = (totalGrade / grades.length).toFixed(1);
                            tableHtml+=`${averageGrade}<br>`
                        }
                        tableHtml += `</td></tr>`;
                    }

                    tableHtml += '</tbody></table>';
                    $('#results-container').html(tableHtml);
                } else {
                    $('#results-container').html('<p>Błąd podczas pobierania wyników.</p>');
                }
            },
            error: function() {
                $('#results-container').html('<p>Błąd podczas pobierania wyników.</p>');
            }
        });
    });
</script>
</body>
</html>
